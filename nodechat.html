<html>
	<head>
		<title>nodechat-tutorial</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
		<style>body {
    margin: 0;
    padding: 0;
    font: 14px/1.5 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    color: #252519;
}
a {
    color: #252519;
}
a:hover {
    text-decoration: underline;
    color: #19469D;
}
p {
    margin: 12px 0;
}
h1, h2, h3 {
    margin: 0;
    padding: 0;
}
table#source {
    width: 100%;
    border-collapse: collapse;
}
table#source td:first-child {
    padding: 30px 40px 30px 40px;
    vertical-align: top;
}
table#source td:first-child,
table#source td:first-child pre {
    width: 450px;
}
table#source td:last-child {
    padding: 30px 0 30px 40px;
    border-left: 1px solid #E5E5EE;
    background: #F5F5FF;
}
table#source tr {
    border-bottom: 1px solid #E5E5EE;
}
table#source tr.filename {
    padding-top: 40px;
    border-top: 1px solid #E5E5EE;
}
table#source tr.filename td:first-child {
    text-transform: capitalize;
}
table#source tr.filename td:last-child {
    font-size: 12px;
}
table#source tr.filename h2 {
    margin: 0;
    padding: 0;
    cursor: pointer;
}
table#source tr.code h1,
table#source tr.code h2,
table#source tr.code h3 {
    margin-top: 30px;
    font-family: "Lucida Grande", "Helvetica Nueue", Arial, sans-serif;
    font-size: 18px;
}
table#source tr.code h2 {
    font-size: 16px;
}
table#source tr.code h3 {
    font-size: 14px;
}
table#source tr.code ul {
    margin: 15px 0 15px 35px;
    padding: 0;
}
table#source tr.code ul li {
    margin: 0;
    padding: 1px 0;
}
table#source tr.code ul li p {
    margin: 0;
    padding: 0;
}
table#source tr.code td:first-child pre {
    padding: 20px;
}
#ribbon {
    position: fixed;
    top: 0;
    right: 0;
}
code .string { color: #219161; }
code .regexp { color: #219161; }
code .keyword { color: #954121; }
code .number { color: #19469D; }
code .comment { color: #bbb; }
code .this { color: #19469D; }</style>
		<script>
			$(function(){
				$('tr.code').hide();
				$('tr.filename').toggle(function(){
					$(this).nextUntil('.filename').fadeIn();
				}, function(){
					$(this).nextUntil('.filename').fadeOut();
				});
			});
		</script>
	</head>
	<body>
<table id="source"><tbody><tr><td><h1>nodechat-tutorial</h1></td><td></td></tr><tr class="filename"><td><h2 id="core.js"><a href="#">core</a></h2></td><td>core.js</td></tr><tr class="code">
<td class="docs">
<p>Include core dependencies.<br></br> </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">_</span> = <span class="variable">require</span>(<span class="string">'underscore'</span>).<span class="variable">_</span>
    , <span class="class">Backbone</span> = <span class="variable">require</span>(<span class="string">'backbone'</span>)</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Include our own modules
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">models</span> = <span class="variable">require</span>(<span class="string">'./models/models'</span>)
    , <span class="variable">auth</span> = <span class="variable">require</span>(<span class="string">'./lib/auth'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Require redis and setup the client 
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">redis</span> = <span class="variable">require</span>(<span class="string">'redis'</span>)
    , <span class="variable">rc</span> = <span class="variable">redis</span>.<span class="variable">createClient</span>()

<span class="variable">rc</span>.<span class="variable">on</span>(<span class="string">'error'</span>, <span class="keyword">function</span>(<span class="variable">err</span>) {
    <span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'Error '</span> + <span class="variable">err</span>);
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Setup connect, express, socket, and the connect-redis session store
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">express</span> = <span class="variable">require</span>(<span class="string">'express'</span>)
    , <span class="variable">app</span> = <span class="variable">express</span>.<span class="variable">createServer</span>()
    , <span class="variable">connect</span> = <span class="variable">require</span>(<span class="string">'connect'</span>)
    , <span class="variable">jade</span> = <span class="variable">require</span>(<span class="string">'jade'</span>)
    , <span class="variable">socket</span> = <span class="variable">require</span>(<span class="string">'socket.io'</span>).<span class="variable">listen</span>(<span class="variable">app</span>)
    , <span class="variable">redisStore</span> = <span class="variable">require</span>(<span class="string">'connect-redis'</span>);

<span class="variable">app</span>.<span class="variable">set</span>(<span class="string">'view engine'</span>, <span class="string">'jade'</span>);
<span class="variable">app</span>.<span class="variable">set</span>(<span class="string">'view options'</span>, {<span class="variable">layout</span>: <span class="variable">false</span>});
<span class="variable">app</span>.<span class="variable">use</span>(<span class="variable">express</span>.<span class="variable">bodyParser</span>());
<span class="variable">app</span>.<span class="variable">use</span>(<span class="variable">express</span>.<span class="variable">cookieParser</span>());
<span class="variable">app</span>.<span class="variable">use</span>(<span class="variable">express</span>.<span class="variable">session</span>({ <span class="variable">store</span>: <span class="keyword">new</span> <span class="variable">redisStore</span>(), <span class="variable">secret</span>: <span class="string">'Secretly I am an elephant'</span> }));</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Setup the routes for GET and POST /login.</p>

<ul><li>GET returns the login.jade template</li><li>POST calls the authentication module to verify login details.<ul><li>Failures are redirected back to the login page.</li></ul></li></ul>

<p>If the authentication module gives us a user object back, we ask connect to regenerate the session and send the client back to index. Note: we are specify a <em>long</em> cookie age so users won't have to log in frequently. We also set the httpOnly flag to false (I know, not so secure) to make the cookie available over <a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/net/Socket.html">Flash Sockets</a>.</p>

<p>/
app.get('/login', function(req, res){
    res.render('login');
});</p>

<p>app.post('/login', function(req, res){
    auth.authenticateUser(req.body.username, req.body.password, function(err, user){
        if (user) {
            // Regenerate session when signing in to prevent fixation 
            req.session.regenerate(function(){
                // Store the user's primary key in the session store to be retrieved, or in this case the entire user object
                console.log('regenerated session id ' + req.session.id);
                req.session.cookie.maxAge = 100 <em> 24 </em> 60 <em> 60 </em> 1000; //Force longer cookie age
                req.session.cookie.httpOnly = false;
                req.session.user = user;</p>

<pre><code>            console.log('Storing new hash for user ' + user.get('name') + ': ' + req.session.user.get('hashPass'));
            res.redirect('/');
        });
    } else {
        req.session.error = 'Authentication failed, please check your username and password.';
        res.redirect('back');
    }
});</code></pre>

<p>});</p>

<p>/**
Sets up routes for GET and POST /signup:</p>

<ul><li>GET returns signup.jade</li><li><p>POST calls createNewUserAccount() in the auth module.</p><ul><li>Failures redirect to the same page</li><li><p>Success redirects back to /login for the user to formally log in</p></li></ul></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">app</span>.<span class="variable">get</span>(<span class="string">'/signup'</span>, <span class="keyword">function</span>(<span class="variable">req</span>, <span class="variable">res</span>){
    <span class="variable">res</span>.<span class="variable">render</span>(<span class="string">'signup'</span>);
});

<span class="variable">app</span>.<span class="variable">post</span>(<span class="string">'/signup'</span>, <span class="keyword">function</span>(<span class="variable">req</span>, <span class="variable">res</span>) {
    <span class="variable">auth</span>.<span class="variable">createNewUserAccount</span>(<span class="variable">req</span>.<span class="variable">body</span>.<span class="variable">username</span>, <span class="variable">req</span>.<span class="variable">body</span>.<span class="variable">password1</span>, <span class="variable">req</span>.<span class="variable">body</span>.<span class="variable">password2</span>, <span class="variable">req</span>.<span class="variable">body</span>.<span class="variable">email</span>, <span class="variable">req</span>.<span class="variable">body</span>.<span class="variable">ponies</span>, <span class="keyword">function</span>(<span class="variable">err</span>, <span class="variable">user</span>){
        <span class="keyword">if</span> (<span class="variable">err</span>) {
            <span class="variable">req</span>.<span class="variable">session</span>.<span class="variable">error</span> = <span class="string">'New user failed, please check your username and password.'</span>;
            <span class="variable">res</span>.<span class="variable">redirect</span>(<span class="string">'back'</span>);
        }
        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">user</span>) {
            <span class="variable">res</span>.<span class="variable">redirect</span>(<span class="string">'/login'</span>);
        }
    });

});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p> Tell connect to destory the session.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">app</span>.<span class="variable">get</span>(<span class="string">'/logout'</span>, <span class="keyword">function</span>(<span class="variable">req</span>, <span class="variable">res</span>){
    <span class="variable">req</span>.<span class="variable">session</span>.<span class="variable">destroy</span>(<span class="keyword">function</span>(){
        <span class="variable">res</span>.<span class="variable">redirect</span>(<span class="string">'home'</span>);
    });
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Server up any static file requested by the client</p>

<h2>TODO should restrict this to only server *public* routes.</h2>
</td>
<td class="code">
<pre><code><span class="variable">app</span>.<span class="variable">get</span>('</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>.(js|css)', function(req, res){
    res.sendfile('./'+req.url);
});</p>

<p>/**</p>

<p> </p>
</td>
<td class="code">
<pre><code><span class="variable">app</span>.<span class="variable">get</span>(<span class="string">'/'</span>, <span class="variable">restrictAccess</span>, <span class="keyword">function</span>(<span class="variable">req</span>, <span class="variable">res</span>){
    <span class="variable">res</span>.<span class="variable">render</span>(<span class="string">'index'</span>, {
        <span class="variable">locals</span>: { <span class="variable">name</span>: <span class="variable">req</span>.<span class="variable">session</span>.<span class="variable">user</span>.<span class="variable">name</span>, <span class="variable">hashPass</span>: <span class="class">JSON</span>.<span class="variable">stringify</span>(<span class="variable">req</span>.<span class="variable">session</span>.<span class="variable">user</span>.<span class="variable">hashPass</span>) }
    });
});

<span class="comment">//This method decides what a valid login looks like. In this case, just verify that we have a session object for the user</span>
<span class="keyword">function</span> <span class="variable">restrictAccess</span>(<span class="variable">req</span>, <span class="variable">res</span>, <span class="variable">next</span>) {
    <span class="keyword">if</span> (<span class="variable">req</span>.<span class="variable">session</span>.<span class="variable">user</span>) {
        <span class="variable">next</span>();
    } <span class="keyword">else</span> {
        <span class="variable">req</span>.<span class="variable">session</span>.<span class="variable">error</span> = <span class="string">'Access denied!'</span>;
        <span class="variable">res</span>.<span class="variable">redirect</span>(<span class="string">'/login'</span>);
    }
};


<span class="comment">//create local state</span>
<span class="keyword">var</span> <span class="variable">activeClients</span> = <span class="number integer">0</span>;
<span class="keyword">var</span> <span class="variable">nodeChatModel</span> = <span class="keyword">new</span> <span class="variable">models</span>.<span class="class">NodeChatModel</span>();


<span class="keyword">function</span> <span class="variable">disconnectAndRedirectClient</span>(<span class="variable">client</span>, <span class="variable">fn</span>) {
    <span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'Disconnecting unauthenticated user'</span>);
    <span class="variable">client</span>.<span class="variable">send</span>({ <span class="variable">event</span>: <span class="string">'disconnect'</span> });
    <span class="variable">client</span>.<span class="variable">connection</span>.<span class="variable">end</span>();
    <span class="variable">fn</span>();
    <span class="keyword">return</span>;
}

<span class="variable">socket</span>.<span class="variable">on</span>(<span class="string">'connection'</span>, <span class="keyword">function</span>(<span class="variable">client</span>){
    <span class="comment">// helper function that goes inside your socket connection</span>
    <span class="variable">client</span>.<span class="variable">connectSession</span> = <span class="keyword">function</span>(<span class="variable">fn</span>) {
        <span class="keyword">if</span> (!<span class="variable">client</span>.<span class="variable">request</span> || !<span class="variable">client</span>.<span class="variable">request</span>.<span class="variable">headers</span> || !<span class="variable">client</span>.<span class="variable">request</span>.<span class="variable">headers</span>.<span class="variable">cookie</span>) {
            <span class="variable">disconnectAndRedirectClient</span>(<span class="variable">client</span>,<span class="keyword">function</span>() {
               <span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'Null request/header/cookie!'</span>);
            });
            <span class="keyword">return</span>;
        }

        <span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'Cookie is'</span> + <span class="variable">client</span>.<span class="variable">request</span>.<span class="variable">headers</span>.<span class="variable">cookie</span>);

        <span class="keyword">var</span> <span class="variable">match</span> = <span class="variable">client</span>.<span class="variable">request</span>.<span class="variable">headers</span>.<span class="variable">cookie</span>.<span class="variable">match</span>(<span class="regexp">/connect\.sid=([^;]+)/</span>);
        <span class="keyword">if</span> (!<span class="variable">match</span> || <span class="variable">match</span>.<span class="variable">length</span> &<span class="variable">lt</span>; <span class="number integer">2</span>) {
            <span class="variable">disconnectAndRedirectClient</span>(<span class="variable">client</span>,<span class="keyword">function</span>() {
                <span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'Failed to find connect.sid in cookie'</span>)
            });
            <span class="keyword">return</span>;
        }

        <span class="keyword">var</span> <span class="variable">sid</span> = <span class="variable">unescape</span>(<span class="variable">match</span>[<span class="number integer">1</span>]);

        <span class="variable">rc</span>.<span class="variable">get</span>(<span class="variable">sid</span>, <span class="keyword">function</span>(<span class="variable">err</span>, <span class="variable">data</span>) {
            <span class="variable">fn</span>(<span class="variable">err</span>, <span class="class">JSON</span>.<span class="variable">parse</span>(<span class="variable">data</span>));
        });
    };

    <span class="variable">client</span>.<span class="variable">connectSession</span>(<span class="keyword">function</span>(<span class="variable">err</span>, <span class="variable">data</span>) {
        <span class="keyword">if</span>(<span class="variable">err</span>) {
            <span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'Error on connectionSession: '</span> + <span class="variable">err</span>);
            <span class="keyword">return</span>;
        }

        <span class="variable">activeClients</span> += <span class="number integer">1</span>;
        <span class="variable">client</span>.<span class="variable">on</span>(<span class="string">'disconnect'</span>, <span class="keyword">function</span>(){<span class="variable">clientDisconnect</span>(<span class="variable">client</span>)});
        <span class="variable">client</span>.<span class="variable">on</span>(<span class="string">'message'</span>, <span class="keyword">function</span>(<span class="variable">msg</span>){<span class="variable">chatMessage</span>(<span class="variable">client</span>, <span class="variable">socket</span>, <span class="variable">msg</span>)});

        <span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'User successfully connected with '</span> + <span class="variable">data</span>.<span class="variable">user</span>.<span class="variable">name</span> + <span class="string">' hash '</span> + <span class="variable">data</span>.<span class="variable">user</span>.<span class="variable">hashPass</span>); 

        <span class="variable">socket</span>.<span class="variable">broadcast</span>({
            <span class="variable">event</span>: <span class="string">'update'</span>,
            <span class="variable">clients</span>: <span class="variable">activeClients</span>
        });

        <span class="keyword">var</span> <span class="variable">ponyWelcome</span> = <span class="keyword">new</span> <span class="variable">models</span>.<span class="class">ChatEntry</span>({<span class="variable">name</span>: <span class="string">'PonyBot'</span>, <span class="variable">text</span>: <span class="string">'Hello '</span> + <span class="variable">data</span>.<span class="variable">user</span>.<span class="variable">name</span> + <span class="string">'. I also feel that ponies '</span> + <span class="variable">data</span>.<span class="variable">user</span>.<span class="variable">ponies</span> + <span class="string">'. Welcome to nodechat.js'</span>});

        <span class="variable">socket</span>.<span class="variable">broadcast</span>({
            <span class="variable">event</span>: <span class="string">'chat'</span>,
            <span class="variable">data</span>: <span class="variable">ponyWelcome</span>.<span class="variable">xport</span>()
        });
    });
});

<span class="keyword">function</span> <span class="variable">chatMessage</span>(<span class="variable">client</span>, <span class="variable">socket</span>, <span class="variable">msg</span>){
    <span class="keyword">var</span> <span class="variable">chat</span> = <span class="keyword">new</span> <span class="variable">models</span>.<span class="class">ChatEntry</span>();
    <span class="variable">chat</span>.<span class="variable">mport</span>(<span class="variable">msg</span>);

    <span class="variable">rc</span>.<span class="variable">incr</span>(<span class="string">'next.chatentry.id'</span>, <span class="keyword">function</span>(<span class="variable">err</span>, <span class="variable">newId</span>) {
        <span class="variable">chat</span>.<span class="variable">set</span>({<span class="variable">id</span>: <span class="variable">newId</span>});
        <span class="variable">nodeChatModel</span>.<span class="variable">chats</span>.<span class="variable">add</span>(<span class="variable">chat</span>);
        
        <span class="keyword">var</span> <span class="variable">expandedMsg</span> = <span class="variable">chat</span>.<span class="variable">get</span>(<span class="string">'id'</span>) + <span class="string">' '</span> + <span class="variable">chat</span>.<span class="variable">get</span>(<span class="string">'name'</span>) + <span class="string">': '</span> + <span class="variable">chat</span>.<span class="variable">get</span>(<span class="string">'text'</span>);
        <span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'('</span> + <span class="variable">client</span>.<span class="variable">sessionId</span> + <span class="string">') '</span> + <span class="variable">expandedMsg</span>);

        <span class="variable">rc</span>.<span class="variable">rpush</span>(<span class="string">'chatentries'</span>, <span class="variable">chat</span>.<span class="variable">xport</span>(), <span class="variable">redis</span>.<span class="variable">print</span>);
        <span class="variable">rc</span>.<span class="variable">bgsave</span>();

        <span class="variable">socket</span>.<span class="variable">broadcast</span>({
            <span class="variable">event</span>: <span class="string">'chat'</span>,
            <span class="variable">data</span>:<span class="variable">chat</span>.<span class="variable">xport</span>()
        }); 
    }); 
}

<span class="keyword">function</span> <span class="variable">clientDisconnect</span>(<span class="variable">client</span>) {
    <span class="variable">activeClients</span> -= <span class="number integer">1</span>;
    <span class="variable">client</span>.<span class="variable">broadcast</span>({<span class="variable">clients</span>:<span class="variable">activeClients</span>})
}

<span class="variable">app</span>.<span class="variable">listen</span>(<span class="number integer">8000</span>)
</code></pre>
</td>
</tr>	</body>
</html></tbody></table>